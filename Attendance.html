<!doctype html>
<html lang="ta">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Staff Attendance</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f7fb;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    .card {
      width: 400px;
      background: #fff;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
      text-align: center;
    }
    h2 {
      margin-bottom: 16px;
      color: #333;
    }
    .input-group {
      position: relative;
      margin-bottom: 16px;
    }
    .input-group i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #888;
    }
    .input-group input {
      width: 100%;
      padding: 10px 36px 10px 36px;
      border-radius: 6px;
      border: 1px solid #cfd8e3;
      font-size: 15px;
    }
    .input-group .toggle-eye {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: #888;
    }
    button {
      width: 100%;
      background: #007bff;
      color: #fff;
      border: none;
      padding: 10px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover {
      background: #0056b3;
    }
    #attSection {
      display: none;
      text-align: center;
    }
    video {
      width: 320px;
      height: 240px;
      background: #000;
      display: block;
      margin: 8px auto;
    }
    select, input[type=text], input[type=password] {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #cfd8e3;
      margin: 6px 0;
    }
    .row {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }
    .row button {
      width: auto;
      background: #007bff;
      color: #fff;
    }
    #loginMsg, #statusMsg {
      color: #c00;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>Staff Attendance</h2>

    <!-- LOGIN -->
    <div id="loginSection">
<i class="fa-solid fa-user"></i><br>
      <div class="input-group">
        
        <input id="username" type="text" placeholder="Email">
      </div>
<i class="fa-solid fa-key"></i><br>
      <div class="input-group">
        
        <input id="password" type="password" placeholder="Password">
        
      </div><i class="fa-solid fa-eye toggle-eye" id="togglePassword"></i><br>
      <button id="loginBtn">Login</button>
      <p id="loginMsg"></p>
    </div>

    <!-- ATTENDANCE -->
    <div id="attSection">
      <div class="row">
        <strong id="staffName">—</strong> &nbsp;
        <span id="staffUser" style="color:#666"></span>
      </div>
      <video id="video" autoplay playsinline></video>
      <canvas id="canvas" width="320" height="240" style="display:none"></canvas>
      <div>
        <select id="status">
          <option>Present</option>
          <option>Half Day</option>
          <option>Leave</option>
        </select>
        <input id="note" placeholder="Note (optional)">
      </div>
      <div class="row">
        <button id="captureBtn">Capture Photo</button>
        <button id="markBtn">Mark Attendance</button>
        <button id="logoutBtn">Logout</button>
      </div>
      <p id="locText">Location: detecting...</p>
      <p id="statusMsg"></p>
    </div>
  </div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycby3lDig4qrf_aVu3y6uM2zPRpu0lcRCJ0E0LKuURUWBVE9l8PmK8kxQWab4zMGusYRo/exec";

const staffList = [
  { name:"V. Shanmuganathan Veerapandiyan", username:"sanmuga0006@gmail.com", password:"Jothi@123", staffId:"001" },
  { name:"S. Bhuvaneshwar SenthilKumar", username:"sbhuvaneshwari536@gmail.com", password:"Jothi@123", staffId:"002" },
  { name:"S. Balamanikandan Sanmugam", username:"balamanikandan@jothi.com", password:"Jothi@123", staffId:"003" },
  { name:"S. Thulasimani", username:"thulasimani@jothi.com", password:"Jothi@123", staffId:"004" },
  { name:"A. Mathivathani Ashok", username:"vathanimathi.90@gmail.com", password:"Jothi@123", staffId:"005" },
  { name:"S. Manikandan", username:"manikandan@jothi.com", password:"Jothi@123", staffId:"006" },
  { name:"Yuvaraj", username:"yuvaraj@jothi.com", password:"Jothi@123", staffId:"007" },
  { name:"Arivalagan", username:"arivu@jothi.com", password:"Jothi@123", staffId:"008" },
  { name:"D. Dhanapal", username:"dhanapal@jothi.com", password:"Jothi@123", staffId:"009" },
  { name:"V. Manikandan Vetrivel", username:"vetrimani@jothi.com", password:"Jothi@123", staffId:"010" },
  { name:"P. Justice Raja Palanichamy", username:"justice@jothi.com", password:"Jothi@123", staffId:"011" },
  { name:"Priya", username:"priya@jothi.com", password:"Jothi@123", staffId:"012" },
  { name:"Karthik", username:"karthik@jothi.com", password:"Jothi@123", staffId:"013" }
 ];

let current = null;
const loginBtn = document.getElementById('loginBtn');
const loginMsg = document.getElementById('loginMsg');
const usernameInput = document.getElementById('username');
const passwordInput = document.getElementById('password');
const togglePassword = document.getElementById('togglePassword');

// password show/hide
togglePassword.addEventListener('click', () => {
  const type = passwordInput.type === 'password' ? 'text' : 'password';
  passwordInput.type = type;
  togglePassword.classList.toggle('fa-eye-slash');
});

loginBtn.addEventListener('click', () => {
  const u = usernameInput.value.trim();
  const p = passwordInput.value.trim();
  if (!u || !p) { loginMsg.textContent = "Enter username & password"; return; }
  const found = staffList.find(s => s.username === u && s.password === p);
  if (!found) { loginMsg.textContent = "Invalid credentials"; return; }

  current = found;
  loginMsg.textContent = "";
  document.getElementById('loginSection').style.display = 'none';
  document.getElementById('attSection').style.display = 'block';
  document.getElementById('staffName').textContent = found.name;
  document.getElementById('staffUser').textContent = found.username;
  startCamera();
  detectLocation();
});

// ===== camera =====
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
let stream = null;
async function startCamera(){
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:'user' }});
    video.srcObject = stream;
  } catch(err){
    alert("Camera error: " + err.message);
  }
}
function stopCamera(){ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }}

// capture
document.getElementById('captureBtn').addEventListener('click', ()=>{
  const vid = document.getElementById('video');
  const c = document.getElementById('canvas');
  c.width = vid.videoWidth || 320;
  c.height = vid.videoHeight || 240;
  const ctx = c.getContext('2d');
  ctx.drawImage(vid, 0, 0, c.width, c.height);
  alert("Photo captured");
});

// ===== location =====
window._lastLat = ""; window._lastLng = ""; window._lastLocText = "";
function detectLocation(){
  if(!navigator.geolocation){ document.getElementById('locText').textContent = "Location not supported"; return; }
  navigator.geolocation.getCurrentPosition((pos)=>{
    window._lastLat = pos.coords.latitude;
    window._lastLng = pos.coords.longitude;
    window._lastLocText = `Lat ${window._lastLat.toFixed(5)}, Lng ${window._lastLng.toFixed(5)}`;
    document.getElementById('locText').textContent = window._lastLocText;
  }, ()=>{ document.getElementById('locText').textContent = "Location denied or error"; });
}
setInterval(()=>{ if(document.getElementById('attSection').style.display !== 'none') detectLocation(); }, 60000);

// logout
document.getElementById('logoutBtn').addEventListener('click', ()=>{
  stopCamera();
  current = null;
  document.getElementById('loginSection').style.display = 'block';
  document.getElementById('attSection').style.display = 'none';
});

// mark attendance
document.getElementById('markBtn').addEventListener('click', async ()=>{
  if(!current) return alert("Login first");
  const c = document.getElementById('canvas');
  const vid = document.getElementById('video');
  c.width = vid.videoWidth || 320;
  c.height = vid.videoHeight || 240;
  const ctx = c.getContext('2d');
  ctx.drawImage(vid,0,0,c.width,c.height);
  const photoBase64 = c.toDataURL('image/png');

  const payload = {
    username: current.username,
    staffName: current.name,
    staffId: current.staffId || '',
    status: document.getElementById('status').value,
    note: document.getElementById('note').value || '',
    lat: window._lastLat || '',
    lng: window._lastLng || '',
    photoBase64: photoBase64
  };

  document.getElementById('statusMsg').textContent = "Sending...";
  try {
    await fetch(WEB_APP_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action:'attendance', payload: payload })
    });
    document.getElementById('statusMsg').textContent = "Sent. Check Google Sheet / Drive.";
    alert("Attendance sent — check Sheet & Drive.");
  } catch(err){
    document.getElementById('statusMsg').textContent = "Error: " + err.message;
  }
});
</script>
</body>
</html>





